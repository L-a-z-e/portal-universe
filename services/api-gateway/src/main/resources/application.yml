# ===================================================================
# API Gateway - Default Configuration
# ===================================================================

server:
  port: 8080
  netty:
    connection-timeout: 2s

spring:
  application:
    name: api-gateway

  # JPA 공통 설정
  jpa:
    open-in-view: false
    properties:
      hibernate:
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # Kafka Producer 공통 설정
  kafka:
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

  cloud:
    gateway:
      # 전역 필터
      default-filters:
        - name: PreserveHostHeader

      # X-Forwarded 헤더
      x-forwarded:
        enabled: true

      # Discovery 설정 (Eureka 비활성화)
      discovery:
        locator:
          enabled: false

      # 라우팅 규칙 (환경별 URL은 application-*.yml의 services.*.url 참조)
      routes:
        # ========== Actuator Health Routes (Status Page 용) ==========
        # Auth Service Actuator
        - id: auth-service-actuator
          uri: ${services.auth.url}
          predicates:
            - Path=/api/auth/actuator/**
          filters:
            - RewritePath=/api/auth/actuator/(?<segment>.*), /actuator/${segment}
          order: 0

        # Blog Service Actuator
        - id: blog-service-actuator
          uri: ${services.blog.url}
          predicates:
            - Path=/api/blog/actuator/**
          filters:
            - RewritePath=/api/blog/actuator/(?<segment>.*), /actuator/${segment}
          order: 0

        # Shopping Service Actuator
        - id: shopping-service-actuator
          uri: ${services.shopping.url}
          predicates:
            - Path=/api/shopping/actuator/**
          filters:
            - RewritePath=/api/shopping/actuator/(?<segment>.*), /actuator/${segment}
          order: 0

        # ========== Auth Service ==========
        # OAuth2 Social Login - Authorization (소셜 로그인 시작)
        - id: auth-service-oauth2-authorization
          uri: ${services.auth.url}
          predicates:
            - Path=/auth-service/oauth2/authorization/**
          filters:
            - StripPrefix=1
          order: 0

        # OAuth2 Social Login - Callback (소셜 로그인 콜백)
        - id: auth-service-oauth2-callback
          uri: ${services.auth.url}
          predicates:
            - Path=/auth-service/login/oauth2/code/**
          filters:
            - StripPrefix=1
          order: 1

        # Auth REST API - /auth-service prefix (Frontend 호출)
        - id: auth-service-api-prefixed
          uri: ${services.auth.url}
          predicates:
            - Path=/auth-service/api/auth/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
          order: 4

        # Profile API - /auth-service prefix (인증 필요)
        - id: auth-service-profile
          uri: ${services.auth.url}
          predicates:
            - Path=/auth-service/api/profile/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
          order: 3

        # Auth REST API (OIDC 아님: 필터 미적용)
        # Auth User API (Signup, Profile, etc.)
        - id: auth-service-users
          uri: ${services.auth.url}
          predicates:
            - Path=/api/users/**
          filters:
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
          order: 5

        - id: auth-service-api
          uri: ${services.auth.url}
          predicates:
            - Path=/api/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
          order: 5

        # ========== Blog Service ==========
        - id: blog-service-file-route
          uri: ${services.blog.url}
          predicates:
            - Path=/api/blog/file/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: blogCircuitBreaker
                fallbackUri: forward:/fallback/blog
            - name: RequestSize
              args:
                max-request-size: 100MB
          order: 1

        - id: blog-service-route
          uri: ${services.blog.url}
          predicates:
            - Path=/api/blog/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: blogCircuitBreaker
                fallbackUri: forward:/fallback/blog
          order: 2

        # ========== Shopping Service ==========
        - id: shopping-service-route
          uri: ${services.shopping.url}
          predicates:
            - Path=/api/shopping/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: shoppingCircuitBreaker
                fallbackUri: forward:/fallback/shopping

# Resilience4j Circuit Breaker 설정
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-type: count_based
        sliding-window-size: 20
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true

    instances:
      authCircuitBreaker:
        base-config: default
      blogCircuitBreaker:
        base-config: default
      shoppingCircuitBreaker:
        base-config: default

  timelimiter:
    configs:
      default:
        timeout-duration: 5s
    instances:
      authCircuitBreaker:
        base-config: default
      blogCircuitBreaker:
        base-config: default
      shoppingCircuitBreaker:
        base-config: default

# JWT 설정 (Auth Service와 동일한 secret key 사용)
jwt:
  secret-key: ${JWT_SECRET_KEY:your-256-bit-secret-key-for-jwt-signing-minimum-32-characters-required}

# 분산 추적용 로그 포맷 (모든 환경 동일)
logging:
  pattern:
    level: "%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]"
