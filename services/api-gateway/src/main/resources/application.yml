# ===================================================================
# API Gateway - Default Configuration
# ===================================================================

server:
  port: 8080
  netty:
    connection-timeout: 2s

spring:
  application:
    name: api-gateway

  # JPA 공통 설정
  jpa:
    open-in-view: false
    properties:
      hibernate:
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # Kafka Producer 공통 설정
  kafka:
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3

  # Redis 설정 (Rate Limiting용, 환경별 override)
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

  cloud:
    gateway:
      server:
        webflux:
          # 전역 필터
          default-filters:
            - name: PreserveHostHeader
            - name: DedupeResponseHeader
              args:
                name: Access-Control-Allow-Origin Access-Control-Allow-Credentials Access-Control-Allow-Methods Access-Control-Allow-Headers
                strategy: RETAIN_UNIQUE

          # X-Forwarded 헤더
          x-forwarded:
            enabled: true

          # 라우팅 규칙 (환경별 URL은 application-*.yml의 services.*.url 참조)
          routes:
            # ========== Actuator Health Routes (Status Page 용) ==========
            # 주의: /actuator/prometheus, /actuator/metrics는 외부 접근 차단 (내부망 전용)
            # 주의: /swagger-ui, /api-docs는 Gateway를 통한 접근 차단 (직접 서비스 포트로만 접근)

            # Auth Service Actuator - health, info만 허용
            - id: auth-service-actuator-health
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/auth/actuator/health,/api/v1/auth/actuator/info
              filters:
                - RewritePath=/api/v1/auth/actuator/(?<segment>.*), /actuator/${segment}
              order: 0

            # Blog Service Actuator - health, info만 허용
            - id: blog-service-actuator-health
              uri: ${services.blog.url}
              predicates:
                - Path=/api/v1/blog/actuator/health,/api/v1/blog/actuator/info
              filters:
                - RewritePath=/api/v1/blog/actuator/(?<segment>.*), /actuator/${segment}
              order: 0

            # Shopping Service Actuator - health, info만 허용
            - id: shopping-service-actuator-health
              uri: ${services.shopping.url}
              predicates:
                - Path=/api/v1/shopping/actuator/health,/api/v1/shopping/actuator/info
              filters:
                - RewritePath=/api/v1/shopping/actuator/(?<segment>.*), /actuator/${segment}
              order: 0

            # ========== Auth Service ==========
            # [Rate Limited] Login API - Strict (5 req/min, Brute Force 방어)
            - id: auth-service-login
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/auth/login
                - Method=POST
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@strictRedisRateLimiter}"
                    key-resolver: "#{@compositeKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 0

            # [Rate Limited] Signup API - Very Strict (3 req/min)
            - id: auth-service-signup
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/users/signup
                - Method=POST
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@signupRedisRateLimiter}"
                    key-resolver: "#{@compositeKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 1

            # OAuth2 Social Login - Authorization (소셜 로그인 시작)
            - id: auth-service-oauth2-authorization
              uri: ${services.auth.url}
              predicates:
                - Path=/auth-service/oauth2/authorization/**
              filters:
                - StripPrefix=1
              order: 2

            # OAuth2 Social Login - Callback (소셜 로그인 콜백)
            - id: auth-service-oauth2-callback
              uri: ${services.auth.url}
              predicates:
                - Path=/auth-service/login/oauth2/code/**
              filters:
                - StripPrefix=1
              order: 3

            # Auth REST API - /auth-service prefix (Frontend 호출)
            - id: auth-service-api-prefixed
              uri: ${services.auth.url}
              predicates:
                - Path=/auth-service/api/v1/auth/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@unauthenticatedRedisRateLimiter}"
                    key-resolver: "#{@ipKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 4

            # Profile API - /auth-service prefix (인증 필요)
            - id: auth-service-profile
              uri: ${services.auth.url}
              predicates:
                - Path=/auth-service/api/v1/profile/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 5

            # Auth REST API (OIDC 아님: 필터 미적용)
            # Auth User API (Signup, Profile, etc.)
            - id: auth-service-users
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/users/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@unauthenticatedRedisRateLimiter}"
                    key-resolver: "#{@ipKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 6

            - id: auth-service-api
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/auth/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@unauthenticatedRedisRateLimiter}"
                    key-resolver: "#{@ipKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 7

            # ========== Auth Service - RBAC/Membership/Seller APIs ==========
            # Admin API (RBAC, Membership, Seller 관리) - 인증 필요
            - id: auth-service-admin
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/admin/rbac/**,/api/v1/admin/memberships/**,/api/v1/admin/seller/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 8

            # Membership Self-Service API - 인증 필요
            - id: auth-service-memberships
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/memberships/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 9

            # Seller Self-Service API - 인증 필요
            - id: auth-service-seller
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/seller/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 10

            # Permission Resolution API - 인증 필요
            - id: auth-service-permissions
              uri: ${services.auth.url}
              predicates:
                - Path=/api/v1/permissions/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: authCircuitBreaker
                    fallbackUri: forward:/fallback/auth
              order: 11

            # ========== Blog Service ==========
            - id: blog-service-file-route
              uri: ${services.blog.url}
              predicates:
                - Path=/api/v1/blog/file/**
              filters:
                - StripPrefix=3
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: blogCircuitBreaker
                    fallbackUri: forward:/fallback/blog
                - name: RequestSize
                  args:
                    max-request-size: 100MB
              order: 8

            - id: blog-service-route
              uri: ${services.blog.url}
              predicates:
                - Path=/api/v1/blog/**
              filters:
                - StripPrefix=3
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@unauthenticatedRedisRateLimiter}"
                    key-resolver: "#{@ipKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: blogCircuitBreaker
                    fallbackUri: forward:/fallback/blog
              order: 9

            # ========== Shopping Service ==========
            - id: shopping-service-route
              uri: ${services.shopping.url}
              predicates:
                - Path=/api/v1/shopping/**
              filters:
                - StripPrefix=3
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@unauthenticatedRedisRateLimiter}"
                    key-resolver: "#{@ipKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: shoppingCircuitBreaker
                    fallbackUri: forward:/fallback/shopping

            # ========== Notification Service ==========
            # WebSocket route for real-time notifications
            - id: notification-service-websocket
              uri: ${services.notification.url:http://localhost:8084}
              predicates:
                - Path=/notification/ws/**
              filters:
                - StripPrefix=1
              order: 49

            # REST API route
            - id: notification-service-route
              uri: ${services.notification.url:http://localhost:8084}
              predicates:
                - Path=/notification/api/v1/notifications/**,/api/v1/notifications/**
              filters:
                - StripPrefix=1
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
              order: 50

            # ========== Chatbot Service (RAG Q&A) ==========
            # Chatbot Health - public
            - id: chatbot-service-health
              uri: ${services.chatbot.url:http://localhost:8086}
              predicates:
                - Path=/api/v1/chat/health
              order: 0

            # Chatbot SSE Stream - authenticated, long-lived
            - id: chatbot-service-stream
              uri: ${services.chatbot.url:http://localhost:8086}
              predicates:
                - Path=/api/v1/chat/stream
                - Method=POST
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: chatbotCircuitBreaker
                    fallbackUri: forward:/fallback/chatbot
              order: 1

            # Chatbot Document API - authenticated (admin)
            - id: chatbot-service-documents
              uri: ${services.chatbot.url:http://localhost:8086}
              predicates:
                - Path=/api/v1/chat/documents/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: chatbotCircuitBreaker
                    fallbackUri: forward:/fallback/chatbot
              order: 2

            # Chatbot API - authenticated
            - id: chatbot-service-route
              uri: ${services.chatbot.url:http://localhost:8086}
              predicates:
                - Path=/api/v1/chat/**
              filters:
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: chatbotCircuitBreaker
                    fallbackUri: forward:/fallback/chatbot
              order: 3

            # ========== Prism Service (AI Orchestration) ==========
            # Prism Service Health/Ready - public
            - id: prism-service-health
              uri: ${services.prism.url:http://localhost:8085}
              predicates:
                - Path=/api/v1/prism/health,/api/v1/prism/ready
              filters:
                - RewritePath=/api/v1/prism/(?<segment>.*), /api/v1/${segment}
              order: 0

            # Prism Service SSE - long-lived connections (no rate limit)
            - id: prism-service-sse
              uri: ${services.prism.url:http://localhost:8085}
              predicates:
                - Path=/api/v1/prism/sse/**
              filters:
                - RewritePath=/api/v1/prism/(?<segment>.*), /api/v1/${segment}
              order: 1

            # Prism Service API - authenticated
            - id: prism-service-route
              uri: ${services.prism.url:http://localhost:8085}
              predicates:
                - Path=/api/v1/prism/**
              filters:
                - RewritePath=/api/v1/prism/(?<segment>.*), /api/v1/${segment}
                - name: RequestRateLimiter
                  args:
                    rate-limiter: "#{@authenticatedRedisRateLimiter}"
                    key-resolver: "#{@userKeyResolver}"
                - name: CircuitBreaker
                  args:
                    name: prismCircuitBreaker
                    fallbackUri: forward:/fallback/prism

# Resilience4j Circuit Breaker 설정
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-type: count_based
        sliding-window-size: 20
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true

    instances:
      authCircuitBreaker:
        base-config: default
      blogCircuitBreaker:
        base-config: default
      shoppingCircuitBreaker:
        base-config: default
      prismCircuitBreaker:
        base-config: default
      chatbotCircuitBreaker:
        base-config: default

  timelimiter:
    configs:
      default:
        timeout-duration: 5s
    instances:
      authCircuitBreaker:
        base-config: default
      blogCircuitBreaker:
        base-config: default
      shoppingCircuitBreaker:
        base-config: default
      prismCircuitBreaker:
        base-config: default
        timeout-duration: 60s  # AI 응답 대기를 위해 타임아웃 늘림
      chatbotCircuitBreaker:
        base-config: default
        timeout-duration: 120s  # RAG + AI 응답 대기

# 공개 경로 설정 (PublicPathProperties)
# Java 기본값과 동일하며, 필요 시 여기서 override 가능
gateway:
  public-paths:
    permit-all:
      - "/notification/ws/**"
      - "/auth-service/**"
      - "/api/v1/auth/**"
      - "/api/v1/users/**"
      - "/api/v1/shopping/products"
      - "/api/v1/shopping/products/**"
      - "/api/v1/shopping/categories"
      - "/api/v1/shopping/categories/**"
      - "/api/v1/shopping/coupons"
      - "/api/v1/shopping/time-deals"
      - "/api/v1/shopping/time-deals/**"
      - "/api/v1/shopping/inventory/batch"
      - "/api/v1/shopping/inventory/stream"
      - "/api/v1/prism/health"
      - "/api/v1/prism/ready"
      - "/api/v1/chat/health"
      - "/api/health/**"
      - "/actuator/**"
      - "/api/v1/*/actuator/**"
    permit-all-get:
      - "/api/v1/blog/**"
      - "/api/v1/memberships/tiers/**"
      - "/api/v1/shopping/search/products"
      - "/api/v1/shopping/search/suggest"
      - "/api/v1/shopping/search/popular"
    skip-jwt-parsing:
      - "/auth-service/"
      - "/api/v1/auth/"
      - "/api/v1/users/"
      - "/api/health/"
      - "/actuator/"
      - "/api/v1/shopping/products"
      - "/api/v1/shopping/categories"
      - "/api/v1/prism/health"
      - "/api/v1/prism/ready"
      - "/api/v1/chat/health"

# JWT 설정 (Auth Service와 동일한 설정 사용, 다중 키 지원)
jwt:
  # 현재 키 ID
  current-key-id: ${JWT_CURRENT_KEY_ID:key-default}
  # 여러 키를 관리 (Auth Service와 동일하게 설정)
  keys:
    key-default:
      # ⚠️ PRODUCTION: 반드시 환경변수 JWT_SECRET_KEY를 설정하세요. 기본값은 개발 전용입니다.
      secret-key: ${JWT_SECRET_KEY:your-256-bit-secret-key-for-jwt-signing-minimum-32-characters-required}
      activated-at: 2026-01-01T00:00:00
      # expires-at은 null이면 만료되지 않음

# 보안 헤더 설정
security:
  headers:
    enabled: true
    frame-options: DENY
    content-type-options: true
    xss-protection: true
    referrer-policy: strict-origin-when-cross-origin
    permissions-policy: "geolocation=(), microphone=(), camera=()"

    # Content Security Policy
    csp:
      enabled: true
      report-only: false
      policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'"

    # HTTP Strict Transport Security
    hsts:
      enabled: true
      https-only: true
      max-age: 31536000
      include-sub-domains: true
      preload: false

    # Cache Control
    cache-control:
      auth-paths: true
      no-cache-paths:
        - "/api/v1/auth/**"
        - "/auth-service/**"
        - "/api/v1/users/**"
        - "/api/v1/*/profile/**"

# Health Aggregation 설정
health-check:
  services:
    - name: api-gateway
      display-name: API Gateway
      url: ${services.gateway.url:http://localhost:8080}
      health-path: /actuator/health
      k8s-deployment-name: api-gateway
    - name: auth-service
      display-name: Auth Service
      url: ${services.auth.url:http://localhost:8081}
      health-path: /actuator/health
      k8s-deployment-name: auth-service
    - name: blog-service
      display-name: Blog Service
      url: ${services.blog.url:http://localhost:8082}
      health-path: /actuator/health
      k8s-deployment-name: blog-service
    - name: shopping-service
      display-name: Shopping Service
      url: ${services.shopping.url:http://localhost:8083}
      health-path: /actuator/health
      k8s-deployment-name: shopping-service
    - name: notification-service
      display-name: Notification Service
      url: ${services.notification.url:http://localhost:8084}
      health-path: /actuator/health
      k8s-deployment-name: notification-service
    - name: prism-service
      display-name: Prism Service
      url: ${services.prism.url:http://localhost:8085}
      health-path: /api/v1/health
      k8s-deployment-name: prism-service
    - name: chatbot-service
      display-name: Chatbot Service
      url: ${services.chatbot.url:http://localhost:8086}
      health-path: /api/v1/chat/health
      k8s-deployment-name: chatbot-service

# 로깅 설정은 logback-spring.xml에서 관리
