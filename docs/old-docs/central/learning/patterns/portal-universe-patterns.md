# Portal Universe 아키텍처 패턴 총정리

## 개요

이 문서는 Portal Universe 프로젝트에서 사용되는 핵심 아키텍처 패턴을 종합적으로 정리합니다.

---

## 1. 아키텍처 패턴 맵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PORTAL UNIVERSE ARCHITECTURE PATTERNS                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        FRONTEND LAYER                                │   │
│   │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │   │
│   │  │ Portal Shell│   │  Shopping   │   │    Blog     │                │   │
│   │  │   (Host)    │◄─►│  (Remote)   │   │  (Remote)   │                │   │
│   │  │   Vue 3     │   │  React 18   │   │   Vue 3     │                │   │
│   │  └─────────────┘   └─────────────┘   └─────────────┘                │   │
│   │         │              Module Federation Pattern                     │   │
│   └─────────┼───────────────────────────────────────────────────────────┘   │
│             │                                                                │
│   ┌─────────▼───────────────────────────────────────────────────────────┐   │
│   │                        API GATEWAY                                   │   │
│   │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │   │
│   │  │    JWT      │   │  Circuit    │   │    Rate     │                │   │
│   │  │ Validation  │   │  Breaker    │   │  Limiting   │                │   │
│   │  └─────────────┘   └─────────────┘   └─────────────┘                │   │
│   │              Spring Cloud Gateway + Resilience4j                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│             │                                                                │
│   ┌─────────▼───────────────────────────────────────────────────────────┐   │
│   │                      MICROSERVICES LAYER                             │   │
│   │                                                                      │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│   │  │   Auth   │  │ Shopping │  │   Blog   │  │  Notify  │            │   │
│   │  │ Service  │  │ Service  │  │ Service  │  │ Service  │            │   │
│   │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │   │
│   │       │             │             │             │                   │   │
│   │       │     Saga Pattern    State Machine      Kafka Consumer       │   │
│   │       │                                                              │   │
│   └───────┼─────────────┼─────────────┼─────────────┼───────────────────┘   │
│           │             │             │             │                        │
│   ┌───────▼─────────────▼─────────────▼─────────────▼───────────────────┐   │
│   │                     DATA & MESSAGE LAYER                             │   │
│   │                                                                      │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│   │  │  MySQL   │  │ MongoDB  │  │  Redis   │  │  Kafka   │            │   │
│   │  │(Shopping)│  │  (Blog)  │  │ (Cache)  │  │(Events)  │            │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 서비스별 주요 패턴

### 2.1 Shopping Service

| 패턴 | 적용 위치 | 목적 |
|------|----------|------|
| **Saga** | OrderSagaOrchestrator | 분산 트랜잭션 관리 |
| **State Machine** | Order, Payment | 상태 전이 규칙 관리 |
| **3단계 재고** | Inventory | 재고 동시성 제어 |
| **스냅샷** | OrderItemSnapshot | 주문 시점 가격 보존 |
| **분산 락** | Redisson | 쿠폰/타임딜 선착순 |
| **Repository** | JPA Repository | 데이터 접근 추상화 |

### 2.2 Blog Service

| 패턴 | 적용 위치 | 목적 |
|------|----------|------|
| **Document Model** | Post, Comment | 역정규화된 데이터 구조 |
| **Embedding** | Author, Tags | 읽기 성능 최적화 |
| **Reference** | Comments (대댓글) | 무한 중첩 방지 |
| **Counter** | 좋아요, 조회수 | 원자적 증감 |
| **Repository** | MongoRepository | 데이터 접근 추상화 |

### 2.3 Auth Service

| 패턴 | 적용 위치 | 목적 |
|------|----------|------|
| **OAuth2** | Authorization Server | 표준 인증 프로토콜 |
| **JWT** | Access/Refresh Token | Stateless 인증 |
| **PKCE** | SPA 인증 | 코드 탈취 방지 |
| **RBAC** | Role, Permission | 권한 관리 |

### 2.4 API Gateway

| 패턴 | 적용 위치 | 목적 |
|------|----------|------|
| **Circuit Breaker** | Resilience4j | 장애 전파 방지 |
| **Rate Limiting** | Redis 기반 | API 사용량 제한 |
| **JWT Validation** | JwtAuthenticationFilter | 토큰 검증 |
| **Route Matching** | Predicate/Filter | 요청 라우팅 |

---

## 3. 핵심 패턴 상세

### 3.1 Saga 패턴 (Orchestration)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ORDER SAGA FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   정상 흐름:                                                                 │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│   │ Reserve    │─►│  Process   │─►│  Deduct    │─►│  Confirm   │           │
│   │ Inventory  │  │  Payment   │  │ Inventory  │  │   Order    │           │
│   └────────────┘  └────────────┘  └────────────┘  └────────────┘           │
│                                                                              │
│   보상 흐름 (결제 실패 시):                                                  │
│   ┌────────────┐  ┌────────────┐                                            │
│   │ Reserve ✓  │─►│ Payment ✗  │  ──► 보상: Release Inventory              │
│   └────────────┘  └────────────┘                                            │
│                                                                              │
│   핵심 파일:                                                                 │
│   • OrderSagaOrchestrator.java                                              │
│   • SagaState.java (영속 상태 추적)                                         │
│   • SagaStep.java (단계 정의)                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 3단계 재고 모델

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    THREE-STAGE INVENTORY MODEL                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Inventory Entity                                  │   │
│   │                                                                      │   │
│   │  totalQuantity = 100     (총 재고)                                   │   │
│   │  reservedQuantity = 20   (예약된 수량)                               │   │
│   │  availableQuantity = 80  (주문 가능 수량)                            │   │
│   │                                                                      │   │
│   │  불변식: total = reserved + available                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   주문 생성: reserve() → reserved +5, available -5                          │
│   결제 완료: deduct()  → reserved -5, total -5                              │
│   주문 취소: release() → reserved -5, available +5                          │
│                                                                              │
│   StockMovement: 모든 재고 변경을 감사 로그로 기록                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Module Federation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MODULE FEDERATION ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Portal Shell (Host, Vue 3, :30000)                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Exposes:                                                            │   │
│   │  • apiClient (axios 인스턴스)                                        │   │
│   │  • authStore (Pinia store)                                           │   │
│   │  • ThemeProvider                                                     │   │
│   │                                                                      │   │
│   │  Remotes:                                                            │   │
│   │  ┌──────────────┐    ┌──────────────┐                                │   │
│   │  │ Shopping FE  │    │   Blog FE    │                                │   │
│   │  │  (React 18)  │    │   (Vue 3)    │                                │   │
│   │  │   :30002     │    │   :30001     │                                │   │
│   │  └──────────────┘    └──────────────┘                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   Shopping Frontend (Remote, React 18)                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Exposes:                                                            │   │
│   │  • bootstrap(container, { apiClient, authStore, callbacks })        │   │
│   │                                                                      │   │
│   │  Uses from Host:                                                     │   │
│   │  • apiClient for API calls                                           │   │
│   │  • authStore for auth state                                          │   │
│   │                                                                      │   │
│   │  Callbacks:                                                          │   │
│   │  • onActivated() - 탭 활성화 시                                      │   │
│   │  • onDeactivated() - 탭 비활성화 시                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Circuit Breaker

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CIRCUIT BREAKER STATES                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────┐    failure ≥ 50%     ┌──────┐    wait 10s    ┌───────────┐    │
│   │ CLOSED │ ───────────────────► │ OPEN │ ─────────────► │ HALF_OPEN │    │
│   └────────┘                      └──────┘                └───────────┘    │
│       ▲                               │                         │           │
│       │                               │                         │           │
│       │  success                      │ 즉시 실패               │ 테스트    │
│       │  rate ≥ 50%                   │ + Fallback              │ 요청      │
│       └───────────────────────────────┴─────────────────────────┘           │
│                                                                              │
│   설정 (Resilience4j):                                                       │
│   • sliding-window-size: 20 (최근 20개 요청)                                │
│   • failure-rate-threshold: 50%                                              │
│   • wait-duration-in-open-state: 10s                                        │
│   • permitted-number-of-calls-in-half-open-state: 5                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 데이터베이스 전략

### 4.1 데이터베이스 선택

| 서비스 | DB | 선택 이유 |
|--------|-----|----------|
| Shopping | MySQL | ACID, 복잡한 관계, 트랜잭션 |
| Blog | MongoDB | Document 모델, 역정규화, 유연한 스키마 |
| Auth | MySQL | 관계형 데이터, 트랜잭션 |
| Cache/Lock | Redis | In-memory, 분산 락, 캐싱 |
| Search | Elasticsearch | 전문 검색, 한글 분석 |

### 4.2 Polyglot Persistence

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      POLYGLOT PERSISTENCE                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Shopping Service                                                           │
│   ├── MySQL (Primary): Order, Payment, Inventory, Product, Coupon           │
│   ├── Redis (Cache): Session, Rate Limit, Distributed Lock                  │
│   └── Elasticsearch: Product Search, Autocomplete                           │
│                                                                              │
│   Blog Service                                                               │
│   ├── MongoDB (Primary): Post, Comment, Series, Tag                         │
│   └── Redis (Cache): View Count, Like Count                                 │
│                                                                              │
│   Auth Service                                                               │
│   ├── MySQL (Primary): User, Role, Permission, OAuth Client                 │
│   └── Redis: Refresh Token, Blacklist                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 이벤트 기반 통신

### 5.1 Kafka Topics

| Topic | Producer | Consumer | 목적 |
|-------|----------|----------|------|
| `order.created` | Shopping | Notification | 주문 알림 |
| `payment.completed` | Shopping | Notification | 결제 알림 |
| `order.shipped` | Shopping | Notification | 배송 알림 |
| `user.registered` | Auth | Notification | 가입 환영 메일 |

### 5.2 이벤트 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EVENT-DRIVEN ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Shopping Service                     Kafka                    Notification │
│   ┌─────────────┐                 ┌──────────────┐             ┌───────────┐│
│   │   Order     │ ───────────────►│order.created │────────────►│  Email    ││
│   │  Service    │  KafkaTemplate  │              │ @KafkaListener          ││
│   └─────────────┘                 └──────────────┘             └───────────┘│
│                                                                              │
│   특징:                                                                      │
│   • 비동기 처리: 주문 서비스는 알림 완료를 기다리지 않음                      │
│   • 느슨한 결합: 서비스 간 직접 의존성 없음                                   │
│   • 장애 격리: 알림 실패가 주문 처리에 영향 없음                              │
│   • 재시도: DLQ를 통한 실패 메시지 재처리                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 보안 아키텍처

### 6.1 인증 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       AUTHENTICATION FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   1. 로그인 요청                                                             │
│   Browser ────► Gateway ────► Auth Service                                  │
│                                    │                                         │
│   2. JWT 발급                      ▼                                         │
│                              Access Token (15분)                             │
│                              Refresh Token (7일, Redis 저장)                 │
│                                    │                                         │
│   3. API 요청                      ▼                                         │
│   Browser ────► Gateway ────► JWT 검증 ────► Shopping Service               │
│            (Authorization)   (JwtAuthFilter)  (X-User-Id Header)            │
│                                                                              │
│   4. 토큰 갱신                                                               │
│   Browser ────► Auth Service ────► Refresh Token 검증 ────► 새 Access Token │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 접근 제어

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ACCESS CONTROL ZONES                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   PUBLIC (인증 불필요):                                                      │
│   • /api/auth/** (로그인, 회원가입)                                          │
│   • GET /api/shopping/products/** (상품 조회)                                │
│   • GET /api/blog/** (블로그 조회)                                           │
│   • /actuator/health                                                        │
│                                                                              │
│   AUTHENTICATED (로그인 필요):                                               │
│   • /api/shopping/cart/**                                                   │
│   • /api/shopping/orders/**                                                 │
│   • POST/PUT/DELETE /api/blog/**                                            │
│                                                                              │
│   ADMIN (관리자 권한):                                                       │
│   • /api/shopping/admin/**                                                  │
│   • 상품 관리, 쿠폰 관리, 재고 관리                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 레이어 아키텍처

### 7.1 백엔드 레이어

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       LAYERED ARCHITECTURE                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Controller Layer                                                    │   │
│   │  • REST 엔드포인트 정의                                              │   │
│   │  • Request/Response DTO 처리                                         │   │
│   │  • ApiResponse.success() 래핑                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Service Layer                                                       │   │
│   │  • 비즈니스 로직                                                     │   │
│   │  • 트랜잭션 관리 (@Transactional)                                    │   │
│   │  • 도메인 이벤트 발행                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Domain Layer                                                        │   │
│   │  • Entity/Aggregate (Order, Payment, Inventory)                      │   │
│   │  • Value Object (Money, Address)                                     │   │
│   │  • Domain Service (가격 계산, 할인 적용)                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Repository Layer                                                    │   │
│   │  • JPA Repository (MySQL)                                            │   │
│   │  • MongoRepository (MongoDB)                                         │   │
│   │  • ElasticsearchRepository (검색)                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 프론트엔드 레이어

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    FRONTEND ARCHITECTURE                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  View Layer (Components)                                             │   │
│   │  • React: JSX Components + Hooks                                     │   │
│   │  • Vue: SFC (script setup + template)                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  State Layer                                                         │   │
│   │  • React: Zustand Store (devtools, persist)                          │   │
│   │  • Vue: Pinia Store (composition API)                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  API Layer                                                           │   │
│   │  • Shared apiClient (axios instance from Host)                       │   │
│   │  • Request/Response interceptors                                     │   │
│   │  • Error handling                                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 패턴 적용 결정 가이드

### 8.1 어떤 상황에 어떤 패턴?

| 상황 | 권장 패턴 | 이유 |
|------|----------|------|
| 여러 서비스 걸친 트랜잭션 | Saga | 분산 트랜잭션 불가 |
| 객체 상태 관리 | State Machine | 전이 규칙 명확화 |
| 외부 서비스 호출 | Circuit Breaker | 장애 격리 |
| 선착순/동시성 제어 | 분산 락 (Redisson) | 원자성 보장 |
| 읽기 성능 최적화 | 캐싱 (Redis) | DB 부하 감소 |
| 서비스 간 비동기 통신 | 이벤트 (Kafka) | 느슨한 결합 |

### 8.2 트레이드오프

| 패턴 | 장점 | 단점 |
|------|------|------|
| Saga | 분산 환경 대응 | 복잡성 증가, 보상 로직 필요 |
| State Machine | 명확한 상태 관리 | 상태 폭발 가능 |
| Circuit Breaker | 장애 전파 방지 | 일시적 서비스 불가 |
| Event-Driven | 느슨한 결합 | 디버깅 어려움 |
| Module Federation | 독립 배포 | 버전 관리 복잡 |

---

## 9. 핵심 정리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PORTAL UNIVERSE PATTERN SUMMARY                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   비즈니스 로직:                                                             │
│   • Saga Pattern - 분산 트랜잭션 관리                                        │
│   • State Machine - Order/Payment 상태 전이                                  │
│   • 3단계 재고 - 동시성 제어                                                 │
│                                                                              │
│   인프라:                                                                    │
│   • Circuit Breaker - 장애 격리 (Resilience4j)                              │
│   • Event-Driven - 비동기 통신 (Kafka)                                       │
│   • Polyglot Persistence - 서비스별 최적 DB                                  │
│                                                                              │
│   프론트엔드:                                                                │
│   • Module Federation - 마이크로 프론트엔드                                   │
│   • Shared State - Host-Remote 상태 동기화                                   │
│   • Keep-Alive - 탭 전환 최적화                                              │
│                                                                              │
│   보안:                                                                      │
│   • OAuth2/JWT - Stateless 인증                                              │
│   • Gateway JWT Validation - 중앙 집중 인증                                  │
│   • RBAC - 역할 기반 접근 제어                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 다음 학습

- [Saga 패턴 심화](./saga-pattern-deep-dive.md)
- [State Machine 패턴](./state-machine-pattern.md)
- [Circuit Breaker 패턴](./circuit-breaker-resilience.md)
- [Module Federation](../../frontend/portal-shell/docs/learning/mfe/module-federation-host.md)
