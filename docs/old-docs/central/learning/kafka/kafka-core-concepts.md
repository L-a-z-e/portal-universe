# Kafka Core Concepts

Apache Kafka의 핵심 개념을 깊이 있게 다룹니다.

---

## 1. Topic, Partition, Offset

### Topic

Topic은 Kafka에서 메시지가 저장되는 **논리적 채널**입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                         Kafka Cluster                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐│
│  │  Topic: orders   │  │  Topic: users    │  │ Topic: payments  ││
│  │                  │  │                  │  │                  ││
│  │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  ││
│  │  │ Partition 0│  │  │  │ Partition 0│  │  │  │ Partition 0│  ││
│  │  └────────────┘  │  │  └────────────┘  │  │  └────────────┘  ││
│  │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  ││
│  │  │ Partition 1│  │  │  │ Partition 1│  │  │  │ Partition 1│  ││
│  │  └────────────┘  │  │  └────────────┘  │  │  └────────────┘  ││
│  └──────────────────┘  └──────────────────┘  └──────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

**주요 특징:**
- 이름으로 식별 (예: `shopping.order.created`)
- 여러 Producer가 동일 Topic에 메시지 발행 가능
- 여러 Consumer가 동일 Topic에서 메시지 구독 가능
- Retention 정책에 따라 메시지 보관 기간 설정

### Partition

Partition은 Topic을 **물리적으로 분할**한 단위입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Topic: shopping.order.created                     │
│                                                                      │
│  Partition 0                                                         │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐               │
│  │ 0  │ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │  ─────────►  │
│  └────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘   oldest→newest│
│                                                                      │
│  Partition 1                                                         │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┐                         │
│  │ 0  │ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │  ─────────────────────► │
│  └────┴────┴────┴────┴────┴────┴────┴────┘                          │
│                                                                      │
│  Partition 2                                                         │
│  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐          │
│  │ 0  │ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 10 │  ──────► │
│  └────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘          │
│                                                                      │
│  * 각 셀의 숫자는 Offset                                             │
└─────────────────────────────────────────────────────────────────────┘
```

**Partition의 역할:**

| 역할 | 설명 |
|------|------|
| 병렬 처리 | 여러 Consumer가 동시에 다른 Partition 소비 |
| 순서 보장 | **동일 Partition 내**에서만 순서 보장 |
| 확장성 | Partition 수 증가로 처리량 향상 |
| 내결함성 | Replication과 결합하여 데이터 보호 |

**Partition Key와 메시지 분배:**

```
┌─────────────────────────────────────────────────────────────────┐
│                        Message Routing                           │
│                                                                  │
│   Producer                                                       │
│      │                                                           │
│      │  Message { key: "order-123", value: {...} }              │
│      ▼                                                           │
│  ┌──────────────────────────────────────────┐                   │
│  │     Partitioner (hash(key) % partitions)  │                   │
│  └──────────────────────────────────────────┘                   │
│      │                                                           │
│      │  hash("order-123") % 3 = 1                               │
│      ▼                                                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Partition 0 │  │ Partition 1 │  │ Partition 2 │             │
│  │             │  │  ◄── HERE   │  │             │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                  │
│  * 동일 key = 동일 Partition = 순서 보장                        │
└─────────────────────────────────────────────────────────────────┘
```

### Offset

Offset은 Partition 내 메시지의 **고유 순차 식별자**입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    Partition 0 - Offset Details                  │
│                                                                  │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐     │
│  │  0   │  1   │  2   │  3   │  4   │  5   │  6   │  7   │     │
│  │ Msg  │ Msg  │ Msg  │ Msg  │ Msg  │ Msg  │ Msg  │ Msg  │     │
│  └──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘     │
│     ▲                    ▲                          ▲           │
│     │                    │                          │           │
│  Earliest            Committed               Latest/LEO         │
│  Offset=0            Offset=3               (Log End Offset)    │
│  (retention          (Consumer의              Offset=7          │
│   시작점)             현재 위치)              (새 메시지 위치)   │
│                                                                  │
│  ◄────────────────────────────────────────────────────────────► │
│       Consumer Lag = LEO(7) - Committed(3) = 4 messages         │
└─────────────────────────────────────────────────────────────────┘
```

**Offset 관리 전략:**

| 전략 | 설명 | 사용 사례 |
|------|------|----------|
| `earliest` | 가장 오래된 메시지부터 | 새 Consumer Group, 데이터 재처리 |
| `latest` | 최신 메시지부터 | 실시간 처리, 과거 데이터 무시 |
| Manual Commit | 처리 완료 후 명시적 커밋 | 정확한 처리 보장 필요 시 |
| Auto Commit | 주기적 자동 커밋 | 간단한 구현, 중복 허용 |

---

## 2. Broker, Cluster, Zookeeper/KRaft

### Broker

Broker는 Kafka 메시지를 저장하고 제공하는 **서버 인스턴스**입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                         Kafka Broker                             │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Broker ID: 1                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │                   Log Manager                        │ │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │ │   │
│  │  │  │ orders-0    │ │ orders-1    │ │ payments-0  │   │ │   │
│  │  │  │ (Leader)    │ │ (Follower)  │ │ (Leader)    │   │ │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────────┐  ┌─────────────────┐               │   │
│  │  │ Request Handler │  │ Network Layer   │               │   │
│  │  │ (Produce/Fetch) │  │ (TCP:9092)      │               │   │
│  │  └─────────────────┘  └─────────────────┘               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  * Port 9092: Client 통신                                       │
│  * Port 9093: Controller 통신 (KRaft)                           │
└─────────────────────────────────────────────────────────────────┘
```

**Broker의 주요 역할:**

1. **메시지 저장**: Producer로부터 받은 메시지를 디스크에 저장
2. **메시지 제공**: Consumer 요청에 따라 메시지 전달
3. **복제 관리**: Leader/Follower 복제 수행
4. **메타데이터 관리**: Topic/Partition 정보 유지

### Cluster

Cluster는 여러 Broker로 구성된 **Kafka 시스템 전체**입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Kafka Cluster                                │
│                                                                      │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐│
│  │    Broker 1       │  │    Broker 2       │  │    Broker 3       ││
│  │                   │  │                   │  │                   ││
│  │ orders-0 (Leader) │  │ orders-0 (Follow) │  │ orders-0 (Follow) ││
│  │ orders-1 (Follow) │  │ orders-1 (Leader) │  │ orders-1 (Follow) ││
│  │ orders-2 (Follow) │  │ orders-2 (Follow) │  │ orders-2 (Leader) ││
│  │                   │  │                   │  │                   ││
│  └────────┬──────────┘  └────────┬──────────┘  └────────┬──────────┘│
│           │                      │                      │           │
│           └──────────────────────┼──────────────────────┘           │
│                                  │                                   │
│                    ┌─────────────┴─────────────┐                    │
│                    │   Controller (Broker 1)   │                    │
│                    │   - Leader 선출           │                    │
│                    │   - 메타데이터 관리       │                    │
│                    └───────────────────────────┘                    │
└─────────────────────────────────────────────────────────────────────┘
```

### Zookeeper vs KRaft

**기존 Zookeeper 방식:**

```
┌─────────────────────────────────────────────────────────────────┐
│                    Zookeeper Mode (Legacy)                       │
│                                                                  │
│  ┌───────────────────────────────────────────┐                  │
│  │           Zookeeper Ensemble              │                  │
│  │  ┌─────┐    ┌─────┐    ┌─────┐           │                  │
│  │  │ ZK1 │◄──►│ ZK2 │◄──►│ ZK3 │           │                  │
│  │  └──┬──┘    └──┬──┘    └──┬──┘           │                  │
│  │     │          │          │               │                  │
│  │     └──────────┼──────────┘               │                  │
│  │                │                          │                  │
│  └────────────────┼──────────────────────────┘                  │
│                   │                                              │
│                   │ 메타데이터 저장                              │
│                   │ - Broker 목록                                │
│                   │ - Topic 설정                                 │
│                   │ - ACL                                        │
│                   ▼                                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                         │
│  │Broker 1 │  │Broker 2 │  │Broker 3 │                         │
│  └─────────┘  └─────────┘  └─────────┘                         │
│                                                                  │
│  단점:                                                           │
│  - 별도 클러스터 운영 필요                                      │
│  - 확장성 제한 (수십만 Partition)                               │
│  - 복잡한 운영                                                   │
└─────────────────────────────────────────────────────────────────┘
```

**KRaft 방식 (Kafka 4.0+):**

```
┌─────────────────────────────────────────────────────────────────┐
│                    KRaft Mode (Modern)                           │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Controller Quorum (Raft)                    │    │
│  │                                                          │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │    │
│  │  │ Controller │  │ Controller │  │ Controller │        │    │
│  │  │  (Active)  │◄►│ (Standby)  │◄►│ (Standby)  │        │    │
│  │  │  Node 1    │  │  Node 2    │  │  Node 3    │        │    │
│  │  └────────────┘  └────────────┘  └────────────┘        │    │
│  │                                                          │    │
│  │  * Raft 프로토콜로 리더 선출                            │    │
│  │  * 메타데이터 로그 복제                                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                          │                                       │
│                          │ 메타데이터 전파                       │
│                          ▼                                       │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                         │
│  │Broker 1 │  │Broker 2 │  │Broker 3 │                         │
│  │         │  │         │  │         │                         │
│  │ 메타데이터│  │ 메타데이터│  │ 메타데이터│                      │
│  │ 캐시     │  │ 캐시     │  │ 캐시     │                        │
│  └─────────┘  └─────────┘  └─────────┘                         │
│                                                                  │
│  장점:                                                           │
│  - 단일 시스템으로 간소화                                       │
│  - 수백만 Partition 지원                                        │
│  - 빠른 Controller Failover                                     │
│  - 간편한 배포 및 운영                                          │
└─────────────────────────────────────────────────────────────────┘
```

**비교 표:**

| 항목 | Zookeeper | KRaft |
|------|-----------|-------|
| 아키텍처 | 외부 의존성 | 자체 포함 |
| Partition 한계 | ~200K | 수백만 |
| Controller Failover | 수십 초 | 수 초 |
| 운영 복잡도 | 높음 | 낮음 |
| Kafka 버전 | 3.x 이하 | 3.3+ (GA: 3.5+) |

---

## 3. Consumer Group, Rebalancing

### Consumer Group

Consumer Group은 **협력적으로 Topic을 소비**하는 Consumer 집합입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│               Topic: shopping.order.created (3 partitions)          │
│                                                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ Partition 0 │     │ Partition 1 │     │ Partition 2 │           │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘           │
│         │                   │                   │                   │
│         │                   │                   │                   │
│         ▼                   ▼                   ▼                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Consumer Group: notification-group              │   │
│  │                                                              │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐     │   │
│  │  │  Consumer A   │ │  Consumer B   │ │  Consumer C   │     │   │
│  │  │  Partition 0  │ │  Partition 1  │ │  Partition 2  │     │   │
│  │  └───────────────┘ └───────────────┘ └───────────────┘     │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  규칙: 1 Partition = 최대 1 Consumer (같은 Group 내)                │
└─────────────────────────────────────────────────────────────────────┘
```

**Consumer 수와 Partition 관계:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                   Consumer-Partition Assignment                      │
│                                                                      │
│  Case 1: Consumers < Partitions (3 partitions, 2 consumers)         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │
│  │   P0    │ │   P1    │ │   P2    │                               │
│  └────┬────┘ └────┬────┘ └────┬────┘                               │
│       │           │           │                                     │
│       ▼           ▼           ▼                                     │
│  ┌─────────────────┐    ┌─────────────┐                            │
│  │   Consumer A    │    │ Consumer B  │                            │
│  │   (P0, P1)      │    │   (P2)      │                            │
│  └─────────────────┘    └─────────────┘                            │
│                                                                      │
│  Case 2: Consumers = Partitions (3 partitions, 3 consumers) ✓ 최적 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │
│  │   P0    │ │   P1    │ │   P2    │                               │
│  └────┬────┘ └────┬────┘ └────┬────┘                               │
│       │           │           │                                     │
│       ▼           ▼           ▼                                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │
│  │Consumer A│ │Consumer B│ │Consumer C│                             │
│  └─────────┘ └─────────┘ └─────────┘                               │
│                                                                      │
│  Case 3: Consumers > Partitions (3 partitions, 4 consumers)         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │
│  │   P0    │ │   P1    │ │   P2    │                               │
│  └────┬────┘ └────┬────┘ └────┬────┘                               │
│       │           │           │                                     │
│       ▼           ▼           ▼                                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                   │
│  │Consumer A│ │Consumer B│ │Consumer C│ │Consumer D│                │
│  │  (P0)    │ │  (P1)    │ │  (P2)    │ │ (IDLE)  │ ◄── 유휴 상태 │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘                   │
└─────────────────────────────────────────────────────────────────────┘
```

### Rebalancing

Rebalancing은 Partition 할당을 **재조정**하는 과정입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Rebalancing Triggers                             │
│                                                                      │
│  1. Consumer 추가                                                    │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Before:                    After:                            │   │
│  │  ┌────┐ ┌────┐ ┌────┐     ┌────┐ ┌────┐ ┌────┐              │   │
│  │  │ P0 │ │ P1 │ │ P2 │     │ P0 │ │ P1 │ │ P2 │              │   │
│  │  └──┬─┘ └──┬─┘ └──┬─┘     └──┬─┘ └──┬─┘ └──┬─┘              │   │
│  │     │      │      │          │      │      │                 │   │
│  │     ▼      ▼      ▼          ▼      ▼      ▼                 │   │
│  │  ┌──────────┐  ┌────┐     ┌────┐ ┌────┐ ┌────┐              │   │
│  │  │ C-A      │  │C-B │  →  │C-A │ │C-B │ │C-C │ ◄── 새 추가  │   │
│  │  │(P0,P1,P2)│  │    │     │(P0)│ │(P1)│ │(P2)│              │   │
│  │  └──────────┘  └────┘     └────┘ └────┘ └────┘              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  2. Consumer 제거/실패                                               │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Before:                    After:                            │   │
│  │  ┌────┐ ┌────┐ ┌────┐     ┌────┐ ┌────┐ ┌────┐              │   │
│  │  │ P0 │ │ P1 │ │ P2 │     │ P0 │ │ P1 │ │ P2 │              │   │
│  │  └──┬─┘ └──┬─┘ └──┬─┘     └──┬─┘ └──┬─┘ └──┬─┘              │   │
│  │     │      │      │          │      └──┬───┘                 │   │
│  │     ▼      ▼      ▼          ▼         ▼                     │   │
│  │  ┌────┐ ┌────┐ ┌────┐     ┌────┐   ┌────────┐               │   │
│  │  │C-A │ │C-B │ │C-C │  →  │C-A │   │  C-C   │               │   │
│  │  │(P0)│ │(P1)│ │(P2)│     │(P0)│   │(P1,P2) │               │   │
│  │  └────┘ └────┘ └─╳──┘     └────┘   └────────┘               │   │
│  │              ▲                                                │   │
│  │              │ C-B 실패                                       │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

**Rebalancing 전략:**

| 전략 | 설명 | 특징 |
|------|------|------|
| Eager (기본) | 모든 Partition 해제 후 재할당 | 단순하지만 일시 중단 |
| Cooperative Sticky | 필요한 Partition만 이동 | 중단 최소화, 점진적 |

**Cooperative Rebalancing:**

```
┌─────────────────────────────────────────────────────────────────────┐
│              Cooperative Sticky Rebalancing                          │
│                                                                      │
│  Phase 1: 일부 Partition만 해제                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  C-A: P0 (유지)     C-B: P1 (유지)     C-C: (신규 대기)       │ │
│  │       P1 → revoke                                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  Phase 2: 해제된 Partition 재할당                                    │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  C-A: P0 (계속 처리)  C-B: P1 (계속 처리)  C-C: P2 (할당)     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  장점: 처리 중단 없이 점진적 재할당                                 │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. Replication Factor, ISR

### Replication Factor

Replication Factor는 각 Partition의 **복제본 수**입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│          Topic: orders (Replication Factor = 3)                      │
│                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │    Broker 1     │  │    Broker 2     │  │    Broker 3     │     │
│  │                 │  │                 │  │                 │     │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │     │
│  │ │ orders-0    │ │  │ │ orders-0    │ │  │ │ orders-0    │ │     │
│  │ │ ★ LEADER    │ │  │ │   Follower  │ │  │ │   Follower  │ │     │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │     │
│  │                 │  │                 │  │                 │     │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │     │
│  │ │ orders-1    │ │  │ │ orders-1    │ │  │ │ orders-1    │ │     │
│  │ │   Follower  │ │  │ │ ★ LEADER    │ │  │ │   Follower  │ │     │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │     │
│  │                 │  │                 │  │                 │     │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │     │
│  │ │ orders-2    │ │  │ │ orders-2    │ │  │ │ orders-2    │ │     │
│  │ │   Follower  │ │  │ │   Follower  │ │  │ │ ★ LEADER    │ │     │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                      │
│  ★ Leader: 모든 읽기/쓰기 처리                                      │
│    Follower: Leader로부터 데이터 복제                               │
└─────────────────────────────────────────────────────────────────────┘
```

**Leader와 Follower의 역할:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Write/Read Flow                                   │
│                                                                      │
│  Producer                                                            │
│     │                                                                │
│     │ 1. Write                                                       │
│     ▼                                                                │
│  ┌─────────────────────┐                                            │
│  │   Leader (Broker 1) │                                            │
│  │   ┌───────────────┐ │                                            │
│  │   │ orders-0      │ │                                            │
│  │   │ [0,1,2,3,4,5] │ │◄──────────────────┐                       │
│  │   └───────────────┘ │                    │                       │
│  └─────────┬───────────┘                    │                       │
│            │                                 │                       │
│            │ 2. Replicate (Fetch)           │ 4. Read               │
│            ▼                                 │                       │
│  ┌─────────────────────┐  ┌─────────────────────┐                  │
│  │  Follower (Broker 2)│  │  Follower (Broker 3)│                  │
│  │  ┌───────────────┐  │  │  ┌───────────────┐  │                  │
│  │  │ orders-0      │  │  │  │ orders-0      │  │                  │
│  │  │ [0,1,2,3,4,5] │  │  │  │ [0,1,2,3,4,5] │  │                  │
│  │  └───────────────┘  │  │  └───────────────┘  │                  │
│  └─────────────────────┘  └─────────────────────┘                  │
│                                                 ▲                   │
│                                                 │                   │
│  * acks=all: 모든 ISR 복제 완료 후 응답        Consumer            │
│  * acks=1: Leader 기록 후 즉시 응답                                │
└─────────────────────────────────────────────────────────────────────┘
```

### ISR (In-Sync Replicas)

ISR은 Leader와 **동기화된 복제본 집합**입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ISR Concept                                  │
│                                                                      │
│  Topic: orders, Partition: 0                                        │
│  Replication Factor: 3                                              │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                     Replicas: [1, 2, 3]                        │  │
│  │                                                                │  │
│  │  ┌──────────────────────────────────────────────────────────┐ │  │
│  │  │                   ISR: [1, 2]                             │ │  │
│  │  │                                                           │ │  │
│  │  │  ┌──────────────┐     ┌──────────────┐                   │ │  │
│  │  │  │  Broker 1    │     │  Broker 2    │                   │ │  │
│  │  │  │  ★ Leader    │     │  Follower    │                   │ │  │
│  │  │  │  Offset: 100 │     │  Offset: 99  │ ◄── 거의 동기화   │ │  │
│  │  │  └──────────────┘     └──────────────┘                   │ │  │
│  │  │                                                           │ │  │
│  │  └───────────────────────────────────────────────────────────┘ │  │
│  │                                                                │  │
│  │  ┌──────────────┐                                             │  │
│  │  │  Broker 3    │ ◄── ISR에서 제외                           │  │
│  │  │  Follower    │     (네트워크 지연/장애)                   │  │
│  │  │  Offset: 50  │     50개 메시지 뒤처짐                      │  │
│  │  └──────────────┘                                             │  │
│  │                                                                │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  replica.lag.time.max.ms: ISR 유지를 위한 최대 지연 시간           │
│  min.insync.replicas: 최소 ISR 수 (이하면 쓰기 거부)               │
└─────────────────────────────────────────────────────────────────────┘
```

**ISR과 데이터 안정성:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    acks 설정과 ISR                                   │
│                                                                      │
│  acks=0: Fire and forget                                            │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Producer ──send──► Broker (응답 안 기다림)                    │ │
│  │  * 가장 빠름, 데이터 손실 가능                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  acks=1: Leader acknowledgment                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Producer ──send──► Leader ──ack──► Producer                   │ │
│  │                        │                                        │ │
│  │                        └── 복제 (비동기)                        │ │
│  │  * Leader 장애 시 데이터 손실 가능                             │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  acks=all (-1): All ISR acknowledgment (권장)                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Producer ──send──► Leader ──replicate──► ISR (all)            │ │
│  │                                              │                  │ │
│  │                        ◄─────── ack ─────────┘                  │ │
│  │  * 가장 안전, 약간의 지연                                      │ │
│  │  * min.insync.replicas와 함께 사용                             │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  권장 설정 (고가용성):                                               │
│  - replication.factor = 3                                           │
│  - min.insync.replicas = 2                                          │
│  - acks = all                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. High Watermark와 Log End Offset

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Partition Offsets                                 │
│                                                                      │
│  Leader (Broker 1)                                                   │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐         │
│  │  0   │  1   │  2   │  3   │  4   │  5   │  6   │  7   │         │
│  └──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘         │
│                                  ▲                    ▲             │
│                                  │                    │             │
│                           High Watermark        Log End Offset      │
│                              (HW=5)               (LEO=7)           │
│                                                                      │
│  Follower (Broker 2)                                                 │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┐                       │
│  │  0   │  1   │  2   │  3   │  4   │  5   │                       │
│  └──────┴──────┴──────┴──────┴──────┴──────┘                       │
│                                        ▲                            │
│                                        │                            │
│                                  LEO=5 (동기화됨)                   │
│                                                                      │
│  Follower (Broker 3)                                                 │
│  ┌──────┬──────┬──────┬──────┬──────┬──────┐                       │
│  │  0   │  1   │  2   │  3   │  4   │  5   │                       │
│  └──────┴──────┴──────┴──────┴──────┴──────┘                       │
│                                        ▲                            │
│                                        │                            │
│                                  LEO=5 (동기화됨)                   │
│                                                                      │
│  * High Watermark: 모든 ISR이 복제 완료한 offset                    │
│  * Consumer는 HW까지만 읽을 수 있음 (일관성 보장)                  │
│  * LEO: 해당 복제본의 마지막 메시지 offset                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. Portal Universe 토픽 구조 분석

### 토픽 아키텍처

Portal Universe는 **이벤트 기반 마이크로서비스 아키텍처**를 사용합니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                Portal Universe Kafka Architecture                    │
│                                                                      │
│  ┌───────────────┐                                                  │
│  │ auth-service  │                                                  │
│  │               │──publish──► user-signup                          │
│  └───────────────┘                                                  │
│                                    │                                 │
│                                    ▼                                 │
│  ┌───────────────┐         ┌──────────────────┐                    │
│  │shopping-service│        │notification-service│                   │
│  │               │         │                    │                   │
│  │  ┌─────────┐  │         │  Consumer Group:  │                   │
│  │  │ Order   │──┼─publish─┤  notification-group│                   │
│  │  │ Service │  │    │    │                    │                   │
│  │  └─────────┘  │    │    │  ┌──────────────┐ │                   │
│  │               │    │    │  │ @KafkaListener│ │                   │
│  │  ┌─────────┐  │    │    │  │              │ │                   │
│  │  │ Payment │──┼────┘    │  │ - order.*    │ │                   │
│  │  │ Service │  │         │  │ - delivery.* │ │                   │
│  │  └─────────┘  │         │  │ - payment.*  │ │                   │
│  │               │         │  │ - coupon.*   │ │                   │
│  │  ┌─────────┐  │         │  │ - timedeal.* │ │                   │
│  │  │Inventory│──┼────►    │  └──────────────┘ │                   │
│  │  │ Service │  │         │                    │                   │
│  │  └─────────┘  │         └──────────────────┘                    │
│  │               │                                                  │
│  │  ┌─────────┐  │                                                  │
│  │  │Delivery │──┼────►                                             │
│  │  │ Service │  │                                                  │
│  │  └─────────┘  │                                                  │
│  └───────────────┘                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 현재 토픽 목록

| Topic Name | Partitions | Replicas | Producer | Consumer |
|------------|------------|----------|----------|----------|
| `user-signup` | 1 | 1 | auth-service | notification-service |
| `shopping.order.created` | 3 | 1 | shopping-service | notification-service |
| `shopping.order.confirmed` | 3 | 1 | shopping-service | - |
| `shopping.order.cancelled` | 3 | 1 | shopping-service | - |
| `shopping.payment.completed` | 3 | 1 | shopping-service | notification-service |
| `shopping.payment.failed` | 3 | 1 | shopping-service | - |
| `shopping.inventory.reserved` | 3 | 1 | shopping-service | - |
| `shopping.delivery.shipped` | 3 | 1 | shopping-service | notification-service |
| `shopping.coupon.issued` | 1 | 1 | shopping-service | notification-service |
| `shopping.timedeal.started` | 1 | 1 | shopping-service | notification-service |

### 토픽 네이밍 컨벤션

```
{service}.{domain}.{action}

예시:
- shopping.order.created    (쇼핑 서비스, 주문 도메인, 생성 액션)
- shopping.payment.completed (쇼핑 서비스, 결제 도메인, 완료 액션)
- shopping.delivery.shipped  (쇼핑 서비스, 배송 도메인, 발송 액션)
```

### Producer 설정 분석

```java
// KafkaConfig.java의 주요 설정
configProps.put(ProducerConfig.ACKS_CONFIG, "all");           // 모든 ISR 복제 확인
configProps.put(ProducerConfig.RETRIES_CONFIG, 3);            // 3회 재시도
configProps.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true); // 멱등성 활성화
```

**설정 해석:**
- `acks=all`: 메시지 손실 방지 (모든 ISR이 복제 완료 후 응답)
- `retries=3`: 일시적 오류 시 자동 재시도
- `enable.idempotence=true`: 중복 메시지 방지 (Exactly-once 보장)

### Consumer 설정 분석

```java
// KafkaConsumerConfig.java의 주요 설정
props.put(ConsumerConfig.GROUP_ID_CONFIG, "notification-group");
props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
factory.getContainerProperties().setAckMode(AckMode.RECORD);
```

**설정 해석:**
- `group.id=notification-group`: Consumer Group 식별자
- `auto.offset.reset=earliest`: 새 Group일 경우 처음부터 읽기
- `enable.auto.commit=false`: 수동 커밋 모드
- `AckMode.RECORD`: 각 메시지 처리 후 offset 커밋

### Dead Letter Queue (DLQ) 패턴

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DLQ Flow in Portal Universe                       │
│                                                                      │
│  shopping.order.created                                              │
│         │                                                            │
│         ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │               NotificationConsumer                           │    │
│  │                                                              │    │
│  │  @KafkaListener(topics = "shopping.order.created")          │    │
│  │  handleOrderCreated(event)                                   │    │
│  │         │                                                    │    │
│  │         ▼                                                    │    │
│  │  ┌──────────────┐                                           │    │
│  │  │ 처리 시도    │                                           │    │
│  │  └──────┬───────┘                                           │    │
│  │         │                                                    │    │
│  │    ┌────┴────┐                                              │    │
│  │    ▼         ▼                                              │    │
│  │ 성공      실패                                               │    │
│  │    │         │                                              │    │
│  │    │    ┌────┴────────┐                                     │    │
│  │    │    │ 재시도 (3회) │                                     │    │
│  │    │    └────┬────────┘                                     │    │
│  │    │         │                                              │    │
│  │    │    ┌────┴────┐                                         │    │
│  │    │    ▼         ▼                                         │    │
│  │    │  성공      실패                                         │    │
│  │    │    │         │                                         │    │
│  │    │    │         ▼                                         │    │
│  │    │    │  shopping.order.created.DLT ◄── Dead Letter Topic │    │
│  │    │    │                                                    │    │
│  │    ▼    ▼                                                    │    │
│  │  Offset Commit                                               │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### KRaft 모드 설정 (Portal Universe)

```yaml
# k8s/infrastructure/kafka.yaml
env:
  - name: KAFKA_PROCESS_ROLES
    value: "broker,controller"              # 단일 노드가 두 역할 수행
  - name: KAFKA_CONTROLLER_QUORUM_VOTERS
    value: "1@kafka:9093"                   # 컨트롤러 쿼럼 (단일 노드)
  - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
    value: "1"                              # 개발 환경: 복제 없음
  - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
    value: "1"                              # 최소 ISR
```

**참고:** 개발 환경이므로 `replicas=1`로 설정되어 있습니다. 프로덕션 환경에서는 `replicas=3`, `min.insync.replicas=2`를 권장합니다.

---

## 7. 주요 개념 요약

| 개념 | 설명 | Portal Universe 적용 |
|------|------|---------------------|
| **Topic** | 메시지 카테고리 | `shopping.order.*`, `shopping.payment.*` |
| **Partition** | Topic의 물리적 분할 | 주문 관련 토픽은 3개 Partition |
| **Offset** | Partition 내 메시지 위치 | 수동 커밋으로 정확한 처리 보장 |
| **Broker** | Kafka 서버 인스턴스 | 단일 노드 (개발 환경) |
| **KRaft** | Zookeeper 없는 모드 | `apache/kafka:4.1.0` 사용 |
| **Consumer Group** | 협력적 소비 그룹 | `notification-group` |
| **Rebalancing** | Partition 재할당 | 자동 처리 |
| **ISR** | 동기화된 복제본 | 개발: 1, 프로덕션 권장: 2+ |
| **DLQ** | 실패 메시지 보관 | `*.DLT` 토픽으로 자동 이동 |

---

## 참고 자료

- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [KRaft: Apache Kafka Without ZooKeeper](https://developer.confluent.io/learn/kraft/)
- [Kafka The Definitive Guide (O'Reilly)](https://www.confluent.io/resources/kafka-the-definitive-guide/)
- Portal Universe 소스 코드:
  - `/services/shopping-service/src/main/java/com/portal/universe/shoppingservice/common/config/KafkaConfig.java`
  - `/services/notification-service/src/main/java/com/portal/universe/notificationservice/config/KafkaConsumerConfig.java`
