# ADR-027: Shopping Service 장바구니 재고 예약 정책

**Status**: Accepted
**Date**: 2026-02-07
**Author**: Laze

## Context

`CartServiceImpl.validateStockAvailability()`에서 장바구니에 상품을 추가할 때 재고 가용량을 확인합니다. 그러나 이 검증은 단순 `SELECT` 조회(soft check)로 수행되며, 락이나 예약 메커니즘 없이 가용 수량만 비교합니다.

이로 인해 TOCTOU(Time-of-Check to Time-of-Use) 문제가 발생합니다:
1. 사용자 A가 재고 1개 남은 상품을 장바구니에 추가 (검증 통과)
2. 사용자 B가 동시에 같은 상품을 장바구니에 추가 (검증 통과)
3. 두 사용자 모두 장바구니에 추가 성공하지만, 실제 주문 시 한 명은 재고 부족

이 문제는 장바구니 추가 시점이 아닌 주문 생성 시점에서 `reserveStock()`이 비관적 락(`@Lock(PESSIMISTIC_WRITE)`)으로 재고를 확보하므로, 최종 정합성은 보장됩니다. 그러나 사용자 경험 측면에서 "장바구니에 넣었는데 주문이 안 되는" 상황이 발생합니다.

## Decision

**현행 soft check를 유지하되, 장바구니 → 주문 전환 시 재고 부족 안내를 개선합니다.**

장바구니 추가 시점에 재고를 예약하지 않습니다. 대신:
- 장바구니 목록 조회 시 실시간 재고 상태를 함께 반환
- 주문 생성 실패 시 구체적인 재고 부족 상품 정보를 응답에 포함

## Alternatives

| 대안 | 장점 | 단점 |
|------|------|------|
| ① 현행 유지 + UX 개선 (채택) | 구현 단순, 재고 점유 없음 | 장바구니 시점과 주문 시점 괴리 |
| ② TTL 기반 임시 예약 | 사용자 기대와 일치 | 예약 만료 로직 복잡, 미결제 예약이 재고 잠금 |
| ③ Redis 실시간 카운터 | 빠른 검증 | Redis-DB 정합성 관리 필요, 카운터 드리프트 위험 |

## Rationale

- **이커머스 업계 관행**: 대부분의 이커머스(쿠팡, 아마존)에서 장바구니 추가 시 재고를 예약하지 않습니다. 예약은 주문/결제 단계에서만 수행합니다.
- **재고 점유 문제 방지**: TTL 예약 시 사용자가 장바구니에 넣고 구매하지 않으면 다른 구매자의 접근이 차단됩니다. 이는 전환율에 부정적입니다.
- **이미 안전장치 존재**: 주문 생성 시 `Inventory.reserveStock()`이 `@Lock(PESSIMISTIC_WRITE)`으로 동시성을 제어하므로, 과판매(oversell)는 발생하지 않습니다.
- **UX 개선으로 충분**: 장바구니 목록에서 실시간 재고 상태를 보여주면, 사용자가 주문 전에 품절 여부를 인지할 수 있습니다.

## Trade-offs

✅ **장점**:
- 구현 복잡도 최소 (프론트엔드 표시 로직만 추가)
- 재고 점유 없이 장바구니 자유도 유지
- 기존 주문 플로우의 정합성 보장 구조 그대로 활용

⚠️ **단점 및 완화**:
- 장바구니 담기 후 주문 시 재고 부족 가능 → (완화: 장바구니 목록 조회 시 재고 상태 표시, 품절 상품 시각적 구분)
- 인기 상품의 경우 사용자 불만 가능 → (완화: 대기열 시스템(ADR-020)으로 고수요 상품은 별도 관리)

## Implementation

### 프론트엔드
- 장바구니 목록 API 응답에 `stockStatus` 필드 추가 (`IN_STOCK`, `LOW_STOCK`, `OUT_OF_STOCK`)
- 품절/부족 상품에 시각적 경고 표시 및 주문 버튼 비활성화

### 백엔드
- `CartController.getCart()` 응답 DTO에 각 아이템별 재고 상태 포함
- `OrderServiceImpl.createOrder()` 실패 응답에 재고 부족 상품 목록 포함

### 코드 참조
- `CartServiceImpl.java:165-172` (현재 soft check)

## References

- [ADR-020: Redis Sorted Set 대기열 시스템](./ADR-020-shopping-queue-system.md)
- [ADR-016: Shopping Saga Pattern과 분산 트랜잭션](./ADR-016-shopping-feature-implementation.md)

---

## 변경 이력

| 날짜 | 변경 내용 | 작성자 |
|------|----------|--------|
| 2026-02-07 | 초안 작성 | Laze |
