# ===================================================================
# Portal Shell: Deployment
# 역할: 마이크로 프론트엔드의 셸 역할을 하는 Portal Shell을 배포합니다.
# ===================================================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: portal-shell  # Deployment 이름
  namespace: portal-universe  # 속한 Namespace
  labels:  # 메타데이터 태그
    app: portal-shell
    tier: frontend
spec:
  replicas: 2  # Pod 2개 실행 (고가용성)

  selector:  # 어떤 Pod를 관리할지 선택
    matchLabels:
      app: portal-shell

  template:  # Pod 템플릿 (Pod 생성 시 사용)
    metadata:
      labels:
        app: portal-shell  # selector와 일치해야 함

    spec:  # Pod 상세 설정
      containers:
        - name: portal-shell  # 컨테이너 이름
          image: portal-universe-portal-shell:latest  # Docker 이미지
          imagePullPolicy: Never # 로컬 Kind 클러스터에 미리 로드된 이미지를 사용

          ports:
            - containerPort: 8080  # 컨테이너 포트
              name: http
              protocol: TCP

          # 컨테이너가 사용할 최소/최대 리소스를 설정합니다.
          resources:
            requests:  # 최소 보장 리소스
              memory: "128Mi"
              cpu: "100m"
            limits:  # 최대 제한 리소스
              memory: "256Mi"
              cpu: "200m"

          # Liveness Probe: Pod가 살아있는지 확인합니다. (nginx.conf의 /health 경로 사용)
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10  # 시작 후 10초 후 체크
            periodSeconds: 30  # 30초마다 체크
            failureThreshold: 3  # 3번 실패하면 재시작

          # Readiness Probe: Pod가 트래픽을 받을 준비가 되었는지 확인합니다.
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
---
# ===================================================================
# Portal Shell: Service
# 역할: 클러스터 내 다른 서비스(특히 Ingress)가 Portal Shell Pod에 접근할 수 있도록
#       고정된 주소(portal-shell:80)를 제공합니다.
# ===================================================================
apiVersion: v1
kind: Service
metadata:
  name: portal-shell
  namespace: portal-universe
  labels:
    app: portal-shell
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app: portal-shell
