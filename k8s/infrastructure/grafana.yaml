# ===================================================================
# Grafana: Deployment
# 역할: Prometheus가 수집한 메트릭을 시각화하는 Grafana 대시보드를 배포합니다.
# ===================================================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: portal-universe
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana-oss:11.4.0
          ports:
            - containerPort: 3000
              name: http
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          env:
            # ⚠️ Production: 기본 admin 계정 대신 Secret으로 관리하세요.
            # kubectl create secret generic grafana-admin --from-literal=user=<사용자명> --from-literal=password=<강력한비밀번호>
            # Grafana 초기 관리자 계정의 비밀번호를 설정합니다.
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: "admin"
            # Grafana 초기 관리자 계정의 사용자 이름을 설정합니다.
            - name: GF_SECURITY_ADMIN_USER
              value: "admin"
            # Grafana 시작 시 자동으로 설치할 플러그인을 지정합니다.
            - name: GF_INSTALL_PLUGINS
              value: "grafana-piechart-panel"

# ===================================================================
# Grafana: Service
# 역할: Grafana 대시보드에 접근할 수 있도록 외부 주소를 제공합니다.
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: portal-universe
  labels:
    app: grafana
spec:
  # ClusterIP 타입으로 변경 - Ingress를 통해 외부에 노출
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: grafana
