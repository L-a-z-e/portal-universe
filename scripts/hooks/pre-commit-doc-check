#!/bin/bash
# =============================================================================
# pre-commit-doc-check: ì„œë¹„ìŠ¤ ë¡œì§/API ë³€ê²½ ì‹œ docs/ ë™ë°˜ ì—¬ë¶€ ê²€ì¦
# 
# ë™ì‘: ê¸°ë³¸ ì°¨ë‹¨, --no-verifyë¡œ ìš°íšŒ ê°€ëŠ¥
# ë²”ìœ„: services/*/src/**, frontend/*/src/** ì¤‘ ë¡œì§ íŒŒì¼ë§Œ ì²´í¬
#       (ì„¤ì •, í…ŒìŠ¤íŠ¸, ë¹Œë“œ íŒŒì¼ ì œì™¸)
# =============================================================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# staged íŒŒì¼ ëª©ë¡
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# =============================================================================
# ì œì™¸ íŒ¨í„´ ì •ì˜ (ë¬¸ì„œ ë¶ˆí•„ìš” íŒŒì¼ë“¤)
# =============================================================================
EXCLUDE_PATTERNS=(
    # ì„¤ì • íŒŒì¼
    '\.yml$'
    '\.yaml$'
    '\.properties$'
    '\.env'
    '\.toml$'
    '\.xml$'           # pom.xml ë“±
    '\.json$'          # package.json ë“±
    '\.lock$'
    '\.gradle$'
    
    # ë¹Œë“œ/ì¸í”„ë¼
    'Dockerfile'
    'docker-compose'
    '\.dockerignore$'
    
    # í…ŒìŠ¤íŠ¸ ì½”ë“œ
    '/test/'
    '/tests/'
    '/__tests__/'
    'Test\.java$'
    '\.spec\.'
    '\.test\.'
    'e2e-tests/'
    
    # ì •ì  ë¦¬ì†ŒìŠ¤
    '\.css$'
    '\.scss$'
    '\.png$'
    '\.jpg$'
    '\.svg$'
    '\.ico$'
    '\.woff'
    
    # IDE/Git ì„¤ì •
    '\.gitignore$'
    '\.editorconfig$'
    '\.vscode/'
    '\.idea/'
    '\.claude/'
    
    # ë¬¸ì„œ ìì²´ (docsë§Œ ìˆ˜ì •í•˜ëŠ” ì»¤ë°‹ì€ OK)
    '^docs/'
    
    # ìŠ¤í¬ë¦½íŠ¸
    '^scripts/'
    
    # ë£¨íŠ¸ ì„¤ì •
    '^\..*'
    '^README\.md$'
)

# =============================================================================
# ì„œë¹„ìŠ¤ ë¡œì§ íŒŒì¼ ê°ì§€
# =============================================================================
requires_docs=false
changed_services=()

for file in $STAGED_FILES; do
    # ì œì™¸ íŒ¨í„´ ì²´í¬
    skip=false
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            skip=true
            break
        fi
    done
    
    if [ "$skip" = true ]; then
        continue
    fi
    
    # ì„œë¹„ìŠ¤ ë¡œì§ íŒŒì¼ì¸ì§€ í™•ì¸
    # Backend: services/*/src/main/**/controller|service|domain|entity|event|dto/**
    # Frontend: frontend/*/src/**/pages|views|components|router|store|api/**
    if echo "$file" | grep -qE '^services/[^/]+/src/main/'; then
        requires_docs=true
        svc_name=$(echo "$file" | cut -d'/' -f2)
        if [[ ! " ${changed_services[@]} " =~ " ${svc_name} " ]]; then
            changed_services+=("$svc_name")
        fi
    elif echo "$file" | grep -qE '^frontend/[^/]+/src/'; then
        requires_docs=true
        svc_name=$(echo "$file" | cut -d'/' -f2)
        if [[ ! " ${changed_services[@]} " =~ " ${svc_name} " ]]; then
            changed_services+=("$svc_name")
        fi
    fi
done

# ë¬¸ì„œ í•„ìš” ì—†ëŠ” ë³€ê²½ì´ë©´ í†µê³¼
if [ "$requires_docs" = false ]; then
    exit 0
fi

# =============================================================================
# docs/ ë³€ê²½ ì—¬ë¶€ í™•ì¸
# =============================================================================
has_docs_change=false
for file in $STAGED_FILES; do
    if echo "$file" | grep -qE '^docs/'; then
        has_docs_change=true
        break
    fi
done

# =============================================================================
# ê²°ê³¼ ì¶œë ¥
# =============================================================================
if [ "$has_docs_change" = true ]; then
    echo -e "${GREEN}âœ… ë¬¸ì„œí™” ì²´í¬ í†µê³¼${NC}"
    echo -e "   ë³€ê²½ ì„œë¹„ìŠ¤: ${changed_services[*]}"
    echo -e "   docs/ ë³€ê²½ ê°ì§€ë¨"
    exit 0
fi

# ì°¨ë‹¨
echo ""
echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${RED}${BOLD} âŒ COMMIT BLOCKED: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ëˆ„ë½${NC}"
echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${YELLOW} ì„œë¹„ìŠ¤ ë¡œì§ì´ ë³€ê²½ë˜ì—ˆìœ¼ë‚˜ docs/ ë³€ê²½ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
echo ""
echo -e "${CYAN} ğŸ“¦ ë³€ê²½ëœ ì„œë¹„ìŠ¤:${NC}"
for svc in "${changed_services[@]}"; do
    echo -e "    â€¢ ${BOLD}${svc}${NC}"
done
echo ""
echo -e "${CYAN} ğŸ“ í•„ìš”í•œ ì‘ì—…:${NC}"
echo -e "    1. ë³€ê²½ ìœ í˜•ì— ë§ëŠ” docs/ íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”"
echo -e "    2. í…œí”Œë¦¿ ì°¸ì¡°: ${BOLD}docs/templates/${NC}"
echo ""
echo -e "${CYAN} ğŸ“‹ ë³€ê²½ ìœ í˜•ë³„ ë¬¸ì„œ ìœ„ì¹˜:${NC}"
echo -e "    Controller/API  â†’ docs/api/{service}/"
echo -e "    ì„œë¹„ìŠ¤ ë¡œì§     â†’ docs/architecture/{service}/"
echo -e "    ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ   â†’ docs/architecture/{service}/"
echo -e "    DB ìŠ¤í‚¤ë§ˆ       â†’ docs/architecture/database/"
echo -e "    ìƒˆ ì„œë¹„ìŠ¤       â†’ docs/api/ + docs/architecture/ + docs/adr/"
echo ""
echo -e "${YELLOW} ğŸ”“ ê¸´ê¸‰ ìš°íšŒ: git commit --no-verify -m \"[skip-docs] ...\"${NC}"
echo -e "${YELLOW}    (ë‹¤ìŒ ì»¤ë°‹ì—ì„œ ë¬¸ì„œ ë³´ì™„ í•„ìˆ˜)${NC}"
echo ""
echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 1
